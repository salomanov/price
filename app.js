const priceBtn=document.getElementById('priceBtn');
const themeBtn=document.getElementById('themeBtn');
const settingsModal=document.getElementById('settingsModal');

const vType=document.getElementById('vType');
const vQty=document.getElementById('vQty');
const vSide=document.getElementById('vSide');
const vTypeButtons=document.getElementById('vTypeButtons');
const vQtyButtons=document.getElementById('vQtyButtons');
const vSideButtons=document.getElementById('vSideButtons');
const vLamBtn=document.getElementById('vLamBtn');
const vLamCheck=document.getElementById('vLamCheck');
const vDiscount=document.getElementById('vDiscount');
const vPrice=document.getElementById('vPrice');
const visitBtn=document.getElementById('visitBtn');

const pPaper=document.getElementById('pPaper');
const pColor=document.getElementById('pColor');
const pFormat=document.getElementById('pFormat');
const pQty=document.getElementById('pQty');
const pSide=document.getElementById('pSide');
const pCut=document.getElementById('pCut');
const pCutQuick=document.getElementById('pCutQuick');
const pPaperButtons=document.getElementById('pPaperButtons');
const pColorButtons=document.getElementById('pColorButtons');
const pFormatButtons=document.getElementById('pFormatButtons');
const pSideButtons=document.getElementById('pSideButtons');
const pDiscount=document.getElementById('pDiscount');
const pPrice=document.getElementById('pPrice');
const printBtn=document.getElementById('printBtn');

const cMode=document.getElementById('cMode');
const cSize=document.getElementById('cSize');
const cTier=document.getElementById('cTier');
const cModeButtons=document.getElementById('cModeButtons');
const cSizeButtons=document.getElementById('cSizeButtons');
const cTierButtons=document.getElementById('cTierButtons');
const cFixedWrap=document.getElementById('cFixedWrap');
const cCustomWrap=document.getElementById('cCustomWrap');
const cHeight=document.getElementById('cHeight');
const cWidth=document.getElementById('cWidth');
const cRate=document.getElementById('cRate');
const cFrameButtons=document.getElementById('cFrameButtons');
const cFrame=document.getElementById('cFrame');
const cFramePrice=document.getElementById('cFramePrice');
const cRoundStep=document.getElementById('cRoundStep');
const cApply20Buttons=document.getElementById('cApply20Buttons');
const cApply20=document.getElementById('cApply20');
const cPrice=document.getElementById('cPrice');
const canvasBtn=document.getElementById('canvasBtn');

const cFormulaRate=document.getElementById('c_formula_rate');
const cFormulaFrame=document.getElementById('c_formula_frame');
const cFormulaRound=document.getElementById('c_formula_round');

const wMaterial=document.getElementById('wMaterial');
const wLam=document.getElementById('wLam');
const wLamBtn=document.getElementById('wLamBtn');
const wCut=document.getElementById('wCut');
const wCutBtn=document.getElementById('wCutBtn');
const wPostWrap=document.getElementById('wPostWrap');
const wPreset=document.getElementById('wPreset');
const wWidth=document.getElementById('wWidth');
const wHeight=document.getElementById('wHeight');
const wQty=document.getElementById('wQty');
const wDiscount=document.getElementById('wDiscount');
const wPrice=document.getElementById('wPrice');
const wideBtn=document.getElementById('wideBtn');
const wMainButtons=document.getElementById('wMainButtons');
const wFilmGroup=document.getElementById('wFilmGroup');
const wPlasticGroup=document.getElementById('wPlasticGroup');
const wPlotterGroup=document.getElementById('wPlotterGroup');
const wSizeWrap=document.getElementById('wSizeWrap');
const wFilmButtons=document.getElementById('wFilmButtons');
const wPlasticButtons=document.getElementById('wPlasticButtons');
const wCutFilmButtons=document.getElementById('wCutFilmButtons');
const wPresetButtons=document.getElementById('wPresetButtons');
const customSize=document.getElementById('customSize');

const lMode=document.getElementById('lMode');
const lType=document.getElementById('lType');
const lSize=document.getElementById('lSize');
const lSizeWrap=document.getElementById('lSizeWrap');
const lQty=document.getElementById('lQty');
const lQtyLabel=document.getElementById('lQtyLabel');
const lSheetsWrap=document.getElementById('lSheetsWrap');
const lSheets=document.getElementById('lSheets');
const lDiscount=document.getElementById('lDiscount');
const lPrice=document.getElementById('lPrice');
const lamBtn=document.getElementById('lamBtn');
const lModeButtons=document.getElementById('lModeButtons');
const lTypeButtons=document.getElementById('lTypeButtons');
const lSizeButtons=document.getElementById('lSizeButtons');

const bfType=document.getElementById('bfType');
const bfQty=document.getElementById('bfQty');
const bfSide=document.getElementById('bfSide');
const bfSideWrap=document.getElementById('bfSideWrap');
const bfDiscount=document.getElementById('bfDiscount');
const bfPrice=document.getElementById('bfPrice');
const bfBtn=document.getElementById('bfBtn');
const bfTypeButtons=document.getElementById('bfTypeButtons');
const bfQtyButtons=document.getElementById('bfQtyButtons');
const bfSideButtons=document.getElementById('bfSideButtons');

const sType=document.getElementById('sType');
const sMugWrap=document.getElementById('sMugWrap');
const sMugType=document.getElementById('sMugType');
const sTshirtWrap=document.getElementById('sTshirtWrap');
const sTshirtType=document.getElementById('sTshirtType');
const sBadgeWrap=document.getElementById('sBadgeWrap');
const sBadgeSize=document.getElementById('sBadgeSize');
const sMagQtyWrap=document.getElementById('sMagQtyWrap');
const sMagQty=document.getElementById('sMagQty');
const sQtyWrap=document.getElementById('sQtyWrap');
const sQty=document.getElementById('sQty');
const sMetersWrap=document.getElementById('sMetersWrap');
const sMeters=document.getElementById('sMeters');
const sDiscount=document.getElementById('sDiscount');
const sPrice=document.getElementById('sPrice');
const sBtn=document.getElementById('sBtn');
const sTypeButtons=document.getElementById('sTypeButtons');
const sMugTypeButtons=document.getElementById('sMugTypeButtons');
const sTshirtTypeButtons=document.getElementById('sTshirtTypeButtons');
const sBadgeSizeButtons=document.getElementById('sBadgeSizeButtons');
const sMagQtyButtons=document.getElementById('sMagQtyButtons');

const priceWideFilmGloss=document.getElementById('priceWideFilmGloss');
const priceWideFilmClear=document.getElementById('priceWideFilmClear');
const priceWideFilmPerf=document.getElementById('priceWideFilmPerf');
const priceWideFilmBacklit=document.getElementById('priceWideFilmBacklit');
const priceWideCanvas=document.getElementById('priceWideCanvas');
const priceWideLamFilm=document.getElementById('priceWideLamFilm');
const priceWidePlastic3=document.getElementById('priceWidePlastic3');
const priceWidePlastic3Lam=document.getElementById('priceWidePlastic3Lam');
const priceWidePlastic5=document.getElementById('priceWidePlastic5');
const priceWidePlastic5Lam=document.getElementById('priceWidePlastic5Lam');
const priceWidePlotterWhiteChina=document.getElementById('priceWidePlotterWhiteChina');
const priceWidePlotterWhiteOracal=document.getElementById('priceWidePlotterWhiteOracal');
const priceWidePlotterColorOracal=document.getElementById('priceWidePlotterColorOracal');
const priceWideCut=document.getElementById('priceWideCut');
const priceWideMinItem=document.getElementById('priceWideMinItem');

const wfMainButtons=document.getElementById('wfMainButtons');
const wfBannerWrap=document.getElementById('wfBannerWrap');
const wfPaperWrap=document.getElementById('wfPaperWrap');
const wfType=document.getElementById('wfType');
const wfQty=document.getElementById('wfQty');
const wfQtyLabel=document.getElementById('wfQtyLabel');
const wfDiscount=document.getElementById('wfDiscount');
const wfPrice=document.getElementById('wfPrice');
const wfBtn=document.getElementById('wfBtn');
const wfBannerButtons=document.getElementById('wfBannerButtons');
const wfPaperMainButtons=document.getElementById('wfPaperMainButtons');
const wfPhotoButtons=document.getElementById('wfPhotoButtons');
const wfPreset=document.getElementById('wfPreset');
const wfPresetButtons=document.getElementById('wfPresetButtons');
const wfSizeWrap=document.getElementById('wfSizeWrap');
const wfCustomSize=document.getElementById('wfCustomSize');
const wfWidth=document.getElementById('wfWidth');
const wfHeight=document.getElementById('wfHeight');
const wfEyeletsWrap=document.getElementById('wfEyeletsWrap');
const wfEyelets=document.getElementById('wfEyelets');
const wfEyeletsEnabled=document.getElementById('wfEyeletsEnabled');
const wfWeldLen=document.getElementById('wfWeldLen');
const wfTrimLen=document.getElementById('wfTrimLen');
const wfEyeletsBtn=document.getElementById('wfEyeletsBtn');
const wfWeldBtn=document.getElementById('wfWeldBtn');
const wfTrimBtn=document.getElementById('wfTrimBtn');
const wfPaperFormat=document.getElementById('wfPaperFormat');
const wfPaperFormatButtons=document.getElementById('wfPaperFormatButtons');
const wfPaperFormatWrap=document.getElementById('wfPaperFormatWrap');
const wfPaperFormatLabel=document.getElementById('wfPaperFormatLabel');

const wfBanner440=document.getElementById('wf_banner_440');
const wfBannerCast=document.getElementById('wf_banner_cast');
const wfBannerLatex=document.getElementById('wf_banner_latex');
const wfPostEyelet=document.getElementById('wf_post_eyelet');
const wfPostWeld=document.getElementById('wf_post_weld');
const wfPostTrim=document.getElementById('wf_post_trim');
const wfWaterA1Photo12=document.getElementById('wf_water_a1_photo_1_2');
const wfWaterA2Photo12=document.getElementById('wf_water_a2_photo_1_2');
const wfWaterA2Photo3p=document.getElementById('wf_water_a2_photo_3p');
const wfWaterA3Photo=document.getElementById('wf_water_a3_photo');
const wfWaterA1Plain12=document.getElementById('wf_water_a1_plain_1_2');
const wfWaterA1Plain3p=document.getElementById('wf_water_a1_plain_3p');
const wfWaterA2Plain12=document.getElementById('wf_water_a2_plain_1_2');
const wfWaterA2Plain3p=document.getElementById('wf_water_a2_plain_3p');
const wfWaterA0Plain12=document.getElementById('wf_water_a0_plain_1_2');
const wfWaterA0Plain3p=document.getElementById('wf_water_a0_plain_3p');
const wfWaterCustomPlainM2=document.getElementById('wf_water_custom_plain_m2');
const wfWaterCustomPhotoM2=document.getElementById('wf_water_custom_photo_m2');
const wfWaterCustomSatinM2=document.getElementById('wf_water_custom_satin_m2');

const order=document.getElementById('order');
const total=document.getElementById('total');
const orderPanel=document.querySelector('.order');
const orderToggle=document.getElementById('orderToggle');
const orderDetails=document.getElementById('orderDetails');
const copyOrderBtn=document.getElementById('copyOrderBtn');
const copyOrderMailBtn=document.getElementById('copyOrderMailBtn');
const designPrice=document.getElementById('designPrice');
const designAddBtn=document.getElementById('designAddBtn');
const designCalcPrice=document.getElementById('designCalcPrice');
const numPad=document.getElementById('numPad');

let orders=[];
let editIndex=null;

const VISIT_QTY={
  digital:[100,200,300,500],
  digital_mat:[50,100],
  offset:[500,1000,2000,3000,5000,7000]
};

const BF_QTY={
  booklet_a4_offset:[500,1000],
  flyer_a6_offset:[1000,2000,3000,5000],
  euro_offset:[1000,2000,3000],
  flyer_a5_offset:[500,1000,2000,10000]
};

const MAG_QTY={
  magnet_acrylic:[10,50,100,150,200],
  magnet_vinyl:[16,48,96,192,384]
};

function num(el, fallback=0){
  const raw=String(el?.value ?? '').replace(',', '.');
  const v=parseFloat(raw);
  return Number.isFinite(v)?v:fallback;
}

function priceInput(id){
  const el=document.getElementById(id);
  return el?num(el,0):0;
}

function rangePrice(ranges, value){
  for(const r of ranges){
    if(value>=r.min && value<=r.max)return r.price;
  }
  return null;
}

const choiceBindings=[];
function setupChoice(selectEl, containerEl, key){
  if(!selectEl || !containerEl)return;
  const binding={selectEl,containerEl,key};
  choiceBindings.push(binding);
  renderChoice(binding);
  containerEl.addEventListener('click',(e)=>{
    const btn=e.target.closest(`[data-choice-${key}]`);
    if(!btn || btn.disabled)return;
    const next=btn.getAttribute(`data-choice-${key}`);
    selectEl.value=next;
    selectEl.dispatchEvent(new Event('change',{bubbles:true}));
    syncChoice(binding);
  });
}

function renderChoice(binding){
  if(!binding)return;
  const {selectEl,containerEl,key}=binding;
  containerEl.innerHTML=[...selectEl.options].filter(o=>o.value!=='').map(o=>`<button type="button" class="choice-btn" data-choice-${key}="${o.value}">${o.text}</button>`).join('');
  syncChoice(binding);
}

function syncChoice(binding){
  if(!binding)return;
  const {selectEl,containerEl,key}=binding;
  const current=selectEl.value;
  [...containerEl.querySelectorAll('.choice-btn')].forEach(btn=>{
    const val=btn.getAttribute(`data-choice-${key}`);
    const opt=[...selectEl.options].find(o=>o.value===val);
    btn.classList.toggle('active',val===current);
    btn.disabled=!!(opt && opt.disabled);
  });
}

function syncAllChoices(){
  choiceBindings.forEach(syncChoice);
}

function bindDiscountQuick(){
  const blocks=[...document.querySelectorAll('.discount-quick')];
  blocks.forEach(block=>{
    const inputId=block.dataset.target;
    const input=document.getElementById(inputId);
    if(!input)return;

    const refresh=()=>{
      const raw=String(input.value).replace(',','.');
      const current=Number(raw);
      [...block.querySelectorAll('[data-discount]')].forEach(btn=>{
        btn.classList.toggle('active',Number(btn.dataset.discount)===current);
      });
    };

    block.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-discount]');
      if(!btn)return;
      input.value=btn.dataset.discount;
      input.dispatchEvent(new Event('input',{bubbles:true}));
      refresh();
    });

    input.addEventListener('input',refresh);
    input.addEventListener('change',refresh);
    refresh();
  });
}

function bindPrintCutQuick(){
  if(!pCutQuick || !pCut)return;
  const btns=[...pCutQuick.querySelectorAll('[data-pcut]')];
  const refresh=()=>{
    const current=Number(String(pCut.value).replace(',','.'));
    btns.forEach(btn=>btn.classList.toggle('active',Number(btn.dataset.pcut)===current));
  };
  pCutQuick.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-pcut]');
    if(!btn)return;
    pCut.value=btn.dataset.pcut;
    pCut.dispatchEvent(new Event('input',{bubbles:true}));
    refresh();
  });
  pCut.addEventListener('input',refresh);
  pCut.addEventListener('change',refresh);
  refresh();
}

function bindDesignService(){
  if(!designPrice || !designAddBtn)return;
  const quick=[...document.querySelectorAll('[data-design]')];

  const refresh=()=>{
    const current=Number(String(designPrice.value).replace(',','.'));
    quick.forEach(btn=>btn.classList.toggle('active',Number(btn.dataset.design)===current));
    if(designCalcPrice){
      designCalcPrice.innerText=current>0?`Цена: ${Math.round(current)} ₽`:'Цена: -';
    }
    designAddBtn.disabled=!(current>0);
  };

  quick.forEach(btn=>{
    btn.addEventListener('click',()=>{
      designPrice.value=btn.dataset.design;
      refresh();
    });
  });

  designPrice.addEventListener('input',refresh);
  designPrice.addEventListener('change',refresh);
  designAddBtn.addEventListener('click',saveDesign);
  refresh();
}

function saveDesign(){
  if(!designPrice)return;
  const price=Math.round(num(designPrice,0));
  if(price<=0)return;
  saveItem({type:'design',title:'Дизайн',desc:'Услуга дизайна',price,params:{price}});
}

const tabButtons=[...document.querySelectorAll('.tab-btn')];
const tabPanels=[...document.querySelectorAll('.tab-panel')];
function switchTab(name){
  tabButtons.forEach(b=>b.classList.toggle('active',b.dataset.tab===name));
  tabPanels.forEach(p=>p.classList.toggle('active',p.id===`tab-${name}`));
}


function setupThemeToggle(){
  if(!themeBtn)return;
  const storageKey='calculatorTheme';

  const applyTheme=(theme)=>{
    const light=(theme==='light');
    document.body.classList.toggle('light-theme',light);
    themeBtn.innerText=light?'\u0422\u0451\u043c\u043d\u0430\u044f \u0442\u0435\u043c\u0430':'\u0421\u0432\u0435\u0442\u043b\u0430\u044f \u0442\u0435\u043c\u0430';
  };

  let saved='dark';
  try{
    saved=localStorage.getItem(storageKey)||'dark';
  }catch(_e){}
  applyTheme(saved);

  themeBtn.addEventListener('click',()=>{
    const next=document.body.classList.contains('light-theme')?'dark':'light';
    applyTheme(next);
    try{localStorage.setItem(storageKey,next);}catch(_e){}
  });
}

function openSettings(){
  if(settingsModal)settingsModal.classList.add('active');
}

function closeSettings(){
  if(settingsModal)settingsModal.classList.remove('active');
}

function toggleCustom(){
  customSize.classList.toggle('hidden',wPreset.value!=='custom');
}

function getVisitPriceType(){
  if(vType.value==='offset')return 'offset';
  return vLamCheck.checked?'digital_mat':'digital';
}

function syncVisitButtons(){
  const type=vType.value;
  const side=vSide.value;
  [...vTypeButtons.querySelectorAll('.choice-btn')].forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.vtype===type);
  });
  [...vSideButtons.querySelectorAll('.choice-btn')].forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.vside===side);
  });
  [...vQtyButtons.querySelectorAll('.choice-btn')].forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.vqty===vQty.value);
  });
  if(vLamBtn){
    vLamBtn.classList.toggle('active',!!vLamCheck.checked);
    vLamBtn.disabled=!!vLamCheck.disabled;
  }
}

function populateVisitQty(){
  const type=getVisitPriceType();
  const list=VISIT_QTY[type]||[];
  const prev=vQty.value;
  vQty.innerHTML=list.map(q=>`<option value="${q}">${q}</option>`).join('');
  vQty.value=list.includes(parseInt(prev,10))?prev:(list[0]?String(list[0]):'');
  vQtyButtons.innerHTML=list.map(q=>`<button type="button" class="choice-btn" data-vqty="${q}">${q}</button>`).join('');
  const isOffset=(type==='offset');
  vSide.disabled=isOffset;
  vLamCheck.disabled=(vType.value==='offset');
  if(vType.value==='offset')vLamCheck.checked=false;
  [...vSideButtons.querySelectorAll('.choice-btn')].forEach(btn=>{btn.disabled=isOffset;});
  syncVisitButtons();
}

function computeVisitPrice(){
  const type=getVisitPriceType();
  const qty=parseInt(vQty.value,10);
  let base=null;
  if(type==='offset'){
    base=priceInput(`vO${qty}`);
  }else{
    const side=vSide.value;
    if(type==='digital')base=priceInput(`vD${qty}${side==='single'?'S':'D'}`);
    if(type==='digital_mat')base=priceInput(`vLM${qty}${side==='single'?'S':'D'}`);
  }
  if(!base)return null;
  return Math.round(base*(1+(num(vDiscount,0)/100)));
}


function syncCanvasToggleButtons(){
  if(cFrameButtons){
    const btn=cFrameButtons.querySelector('[data-cframe]');
    if(btn)btn.classList.toggle('active',!!(cFrame&&cFrame.checked));
  }
  if(cApply20Buttons){
    const btn=cApply20Buttons.querySelector('[data-cdisc20]');
    if(btn)btn.classList.toggle('active',!!(cApply20&&cApply20.checked));
  }
}

function updateCanvasControls(){
  if(!cMode)return;
  const isCustom=cMode.value==='custom';
  if(cFixedWrap)cFixedWrap.classList.toggle('hidden',isCustom);
  if(cCustomWrap)cCustomWrap.classList.toggle('hidden',!isCustom);

  if(isCustom){
    if(cFormulaRate && cRate)cRate.value=cFormulaRate.value;
    if(cFormulaFrame && cFramePrice)cFramePrice.value=cFormulaFrame.value;
    if(cFormulaRound && cRoundStep)cRoundStep.value=cFormulaRound.value;
  }
  syncCanvasToggleButtons();
  syncAllChoices();
}

function ceilToStep(value, step){
  const s=Math.max(1,step||1);
  return Math.ceil(value/s)*s;
}

function computeCanvasPrice(){
  if(!cMode)return null;

  if(cMode.value==='fixed'){
    const size=cSize.value;
    const tier=cTier.value;
    const base=priceInput(`c_${size}_${tier}`);
    if(!base)return null;
    return Math.round(base);
  }

  const h=Math.max(1,num(cHeight,0));
  const w=Math.max(1,num(cWidth,0));
  const rate=Math.max(0,num(cRate,0));
  const frameRate=Math.max(0,num(cFramePrice,0));
  const step=Math.max(1,num(cRoundStep,50));
  if(!h || !w || !rate)return null;

  let sum=0;
  if(cFrame && cFrame.checked){
    sum=((((h+4)*(w+4))/10000)*rate)+(((h+w)*2)*frameRate/100);
  }else{
    sum=((h*w)/10000)*rate;
  }

  let result=ceilToStep(sum,step);
  if(cApply20 && cApply20.checked){
    result=ceilToStep(result-(result*20/100),step);
  }
  return Math.round(result);
}

function saveCanvas(){
  const price=computeCanvasPrice();
  if(price===null)return;

  let desc='';
  if(cMode.value==='fixed'){
    const tierLabel=cTier.options[cTier.selectedIndex].text;
    desc=`${cSize.value} \u0441\u043c, ${tierLabel}`;
  }else{
    const frameLabel=(cFrame && cFrame.checked)?', \u043f\u043e\u0434\u0440\u0430\u043c\u043d\u0438\u043a':'';
    const d20=(cApply20 && cApply20.checked)?', \u0441\u043a\u0438\u0434\u043a\u0430 20%':'';
    desc=`${Math.round(num(cHeight,0))}x${Math.round(num(cWidth,0))} \u0441\u043c${frameLabel}${d20}`;
  }

  saveItem({type:'canvas',title:'\u041f\u0435\u0447\u0430\u0442\u044c \u043d\u0430 \u0445\u043e\u043b\u0441\u0442\u0435',desc,price,params:{
    mode:cMode.value,size:cSize.value,tier:cTier.value,
    h:cHeight.value,w:cWidth.value,rate:cRate.value,frame:!!(cFrame&&cFrame.checked),
    framePrice:cFramePrice.value,roundStep:cRoundStep.value,apply20:!!(cApply20&&cApply20.checked)
  }});
}

function updatePrintControls(){
  const paper=pPaper.value;
  const a3Option=[...pFormat.options].find(o=>o.value==='A3');
  if(paper==='80'){
    pColor.disabled=false;
    if(a3Option)a3Option.disabled=true;
    if(pFormat.value==='A3')pFormat.value='A4';
  }else{
    pColor.value='color';
    pColor.disabled=true;
    if(a3Option)a3Option.disabled=false;
  }
  syncAllChoices();
}

function getPrintPricePerSide(){
  const qty=parseInt(pQty.value,10);
  if(!qty || qty<1)return null;
  const format=pFormat.value;
  const paper=pPaper.value;
  const color=pColor.value;

  if(paper==='80'){
    if(format!=='A4')return null;
    if(color==='bw'){
      return rangePrice([
        {min:1,max:10,price:priceInput('p80_1_10_bw')},
        {min:11,max:50,price:priceInput('p80_11_50_bw')},
        {min:51,max:100,price:priceInput('p80_51_100_bw')},
        {min:101,max:500,price:priceInput('p80_101_500_bw')}
      ],qty);
    }
    return rangePrice([
      {min:1,max:10,price:priceInput('p80_1_10_c')},
      {min:11,max:50,price:priceInput('p80_11_50_c')},
      {min:51,max:100,price:priceInput('p80_51_100_c')},
      {min:101,max:500,price:priceInput('p80_101_500_c')}
    ],qty);
  }

  if(paper==='115'){
    if(color!=='color')return null;
    if(format==='A4'){
      return rangePrice([
        {min:1,max:4,price:priceInput('p115_a4_1_4')},
        {min:5,max:20,price:priceInput('p115_a4_5_20')},
        {min:21,max:100,price:priceInput('p115_a4_20_100')},
        {min:101,max:500,price:priceInput('p115_a4_101_500')}
      ],qty);
    }
    return rangePrice([
      {min:1,max:2,price:priceInput('p115_a3_1_2')},
      {min:3,max:20,price:priceInput('p115_a3_3_20')},
      {min:21,max:100,price:priceInput('p115_a3_20_100')},
      {min:101,max:500,price:priceInput('p115_a3_101_500')}
    ],qty);
  }

  if(paper==='self'){
    if(color!=='color')return null;
    if(format==='A4')return priceInput('pSelf_A4');
    return priceInput('pSelf_A3');
  }

  if(paper==='250'){
    if(color!=='color')return null;
    if(format==='A4'){
      return rangePrice([
        {min:1,max:4,price:priceInput('p250_a4_1_4')},
        {min:5,max:20,price:priceInput('p250_a4_5_20')},
        {min:21,max:500,price:priceInput('p250_a4_21_500')}
      ],qty);
    }
    return rangePrice([
      {min:1,max:2,price:priceInput('p250_a3_1_2')},
      {min:3,max:20,price:priceInput('p250_a3_3_20')},
      {min:21,max:500,price:priceInput('p250_a3_21_500')}
    ],qty);
  }

  return null;
}

function computePrintPrice(){
  const perSide=getPrintPricePerSide();
  if(perSide===null)return null;
  const qty=parseInt(pQty.value,10);
  const sides=num(pSide,1);
  const printBase=perSide*qty*sides;
  const cutAdd=Math.max(0,num(pCut,0));
  return Math.round((printBase+cutAdd)*(1+(num(pDiscount,0)/100)));
}


function updateLaminationControls(){
  const mode=(lMode?lMode.value:'');
  const hasMode=(mode==='lam' || mode==='bind');
  const allowed=(mode==='lam')?['lam_gloss','lam_matte']:['spiral_plastic','spiral_metal','hard_cover'];

  if(lTypeButtons)lTypeButtons.classList.toggle('hidden',!hasMode);
  if(lTypeButtons){
    [...lTypeButtons.querySelectorAll('[data-choice-ltype]')].forEach(btn=>{
      const show=hasMode && allowed.includes(btn.dataset.choiceLtype);
      btn.classList.toggle('hidden',!show);
    });
  }

  if(!hasMode){
    if(lSizeWrap)lSizeWrap.classList.add('hidden');
    if(lSheetsWrap)lSheetsWrap.classList.add('hidden');
    if(lQtyLabel)lQtyLabel.textContent='\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e';
    syncAllChoices();
    return;
  }

  if(!allowed.includes(lType.value))lType.value=allowed[0];
  const type=lType.value;
  const isSpiral=(type==='spiral_plastic' || type==='spiral_metal');
  lSizeWrap.classList.toggle('hidden',type==='hard_cover');
  lSize.disabled=(type==='hard_cover');
  lSheetsWrap.classList.toggle('hidden',!isSpiral);
  lQtyLabel.textContent=isSpiral?'\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0438\u0437\u0434\u0435\u043b\u0438\u0439':'\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e';
  syncAllChoices();
}
function computeLaminationPrice(){
  const mode=(lMode?lMode.value:'');
  if(mode!=='lam' && mode!=='bind')return null;
  const type=lType.value;
  const qty=Math.max(1,parseInt(lQty.value,10)||1);
  const sheets=Math.max(1,parseInt(lSheets.value,10)||1);
  const size=lSize.value;
  let per=null;

  if(type==='lam_gloss'){
    if(size==='ltA4'){
      per=rangePrice([
        {min:1,max:10,price:priceInput('lG_ltA4_1_10')},
        {min:11,max:999999,price:priceInput('lG_ltA4_10p')}
      ],qty);
    }else{
      const suf=size==='A4'?'A4':'A3';
      per=rangePrice([
        {min:1,max:10,price:priceInput(`lG_1_10_${suf}`)},
        {min:11,max:30,price:priceInput(`lG_11_30_${suf}`)},
        {min:31,max:50,price:priceInput(`lG_31_50_${suf}`)},
        {min:51,max:999999,price:priceInput(`lG_50p_${suf}`)}
      ],qty);
    }
    if(per===null)return null;
    return Math.round(per*qty*(1+(num(lDiscount,0)/100)));
  }

  if(type==='lam_matte'){
    if(size==='ltA4')return null;
    const suf=size==='A4'?'A4':'A3';
    per=rangePrice([
      {min:1,max:10,price:priceInput(`lM_1_10_${suf}`)},
      {min:11,max:50,price:priceInput(`lM_11_50_${suf}`)},
      {min:51,max:999999,price:priceInput(`lM_50p_${suf}`)}
    ],qty);
    if(per===null)return null;
    return Math.round(per*qty*(1+(num(lDiscount,0)/100)));
  }

  if(type==='spiral_plastic'){
    if(size==='ltA4')return null;
    const suf=size==='A4'?'A4':'A3';
    per=rangePrice([
      {min:1,max:50,price:priceInput(`spP_0_50_${suf}`)},
      {min:51,max:100,price:priceInput(`spP_50_100_${suf}`)},
      {min:101,max:200,price:priceInput(`spP_100_200_${suf}`)},
      {min:201,max:300,price:priceInput(`spP_200_300_${suf}`)}
    ],sheets);
    if(per===null)return null;
    return Math.round(per*qty*(1+(num(lDiscount,0)/100)));
  }

  if(type==='spiral_metal'){
    if(size==='ltA4')return null;
    const suf=size==='A4'?'A4':'A3';
    per=rangePrice([
      {min:1,max:50,price:priceInput(`spM_0_50_${suf}`)},
      {min:51,max:100,price:priceInput(`spM_50_100_${suf}`)}
    ],sheets);
    if(per===null)return null;
    return Math.round(per*qty*(1+(num(lDiscount,0)/100)));
  }

  if(type==='hard_cover'){
    per=priceInput('hard_cover');
    if(!per)return null;
    return Math.round(per*qty*(1+(num(lDiscount,0)/100)));
  }

  return null;
}

function populateBfQty(){
  const list=BF_QTY[bfType.value]||[];
  const current=parseInt(bfQty.value,10);
  bfQty.innerHTML=list.map(q=>`<option value="${q}">${q}</option>`).join('');
  if(list.includes(current))bfQty.value=String(current);
  else bfQty.value=list[0]?String(list[0]):'';
  renderChoice(choiceBindings.find(b=>b.selectEl===bfQty));
  const type=bfType.value;
  const qty=parseInt(bfQty.value,10)||0;
  const needSide=((type==='flyer_a6_offset' && qty===5000) || (type==='flyer_a5_offset' && qty===10000));
  bfSideWrap.classList.toggle('hidden',!needSide);
  bfSide.disabled=!needSide;
  [...bfSideButtons.querySelectorAll('.choice-btn')].forEach(btn=>{btn.disabled=bfSide.disabled;});
  syncAllChoices();
}

function computeBfPrice(){
  const type=bfType.value;
  const qty=parseInt(bfQty.value,10);
  let base=null;

  if(type==='booklet_a4_offset')base=priceInput(`bOff_${qty}`);

  if(type==='flyer_a6_offset'){
    if(qty===5000){
      base=bfSide.value==='double'?priceInput('fOff_5000_44'):priceInput('fOff_5000_40');
    }else{
      base=priceInput(`fOff_${qty}`);
    }
  }

  if(type==='euro_offset')base=priceInput(`eOff_${qty}`);

  if(type==='flyer_a5_offset'){
    if(qty===10000){
      base=bfSide.value==='double'?priceInput('fA5Off_10000_44'):priceInput('fA5Off_10000_40');
    }else{
      base=priceInput(`fA5Off_${qty}`);
    }
  }

  if(!base)return null;
  return Math.round(base*(1+(num(bfDiscount,0)/100)));
}

function updateSouvenirControls(){
  const t=sType.value;
  sMugWrap.classList.toggle('hidden',t!=='mug');
  sTshirtWrap.classList.toggle('hidden',t!=='tshirt');
  sBadgeWrap.classList.toggle('hidden',t!=='badge');
  sMagQtyWrap.classList.toggle('hidden',!(t==='magnet_acrylic'||t==='magnet_vinyl'));
  sQtyWrap.classList.toggle('hidden',t==='uvdtf' || t==='magnet_acrylic' || t==='magnet_vinyl');
  sMetersWrap.classList.toggle('hidden',t!=='uvdtf');

  if(t==='magnet_acrylic' || t==='magnet_vinyl'){
    const list=MAG_QTY[t]||[];
    const current=parseInt(sMagQty.value,10);
    sMagQty.innerHTML=list.map(q=>`<option value="${q}">${q}</option>`).join('');
    if(list.includes(current))sMagQty.value=String(current);
    else sMagQty.value=list[0]?String(list[0]):'';
    renderChoice(choiceBindings.find(b=>b.selectEl===sMagQty));
  }
  syncAllChoices();
}

function computeSouvenirPrice(){
  const t=sType.value;
  const qty=Math.max(1,parseInt(sQty.value,10)||1);
  let total=null;

  if(t==='mug'){
    const type=sMugType.value;
    let per=null;
    if(type==='white'){
      per=rangePrice([
        {min:1,max:1,price:priceInput('mugW_1')},
        {min:4,max:10,price:priceInput('mugW_4_10')},
        {min:11,max:20,price:priceInput('mugW_10_20')},
        {min:21,max:50,price:priceInput('mugW_20_50')},
        {min:51,max:999999,price:priceInput('mugW_50p')}
      ],qty);
    }
    if(type==='color'){
      if(qty!==1)return null;
      per=priceInput('mugC_1');
    }
    if(type==='chameleon'){
      if(qty!==1)return null;
      per=priceInput('mugCh_1');
    }
    if(!per)return null;
    total=per*qty;
  }

  if(t==='plate'){
    const per=priceInput('plate_1');
    if(!per)return null;
    total=per*qty;
  }

  if(t==='tshirt'){
    if(qty>10)return null;
    let per=null;
    if(sTshirtType.value==='sub_1')per=priceInput('tshirt_sub_1');
    if(sTshirtType.value==='sub_2')per=priceInput('tshirt_sub_2');
    if(sTshirtType.value==='dtf_no')per=priceInput('tshirt_dtf_no');
    if(sTshirtType.value==='dtf_with')per=priceInput('tshirt_dtf_with');
    if(!per)return null;
    total=per*qty;
  }

  if(t==='magnet_acrylic'){
    const q=parseInt(sMagQty.value,10);
    const per=priceInput(`magA_${q}`);
    if(!per)return null;
    total=per*q;
  }

  if(t==='magnet_vinyl'){
    const q=parseInt(sMagQty.value,10);
    const per=priceInput(`magV_${q}`);
    if(!per)return null;
    total=per*q;
  }

  if(t==='badge'){
    const size=sBadgeSize.value;
    const per=rangePrice([
      {min:1,max:3,price:priceInput(`badge${size}_1_3`)},
      {min:4,max:10,price:priceInput(`badge${size}_4_10`)},
      {min:11,max:19,price:priceInput(`badge${size}_11_19`)},
      {min:20,max:99,price:priceInput(`badge${size}_20_99`)},
      {min:100,max:299,price:priceInput(`badge${size}_100_299`)},
      {min:300,max:499,price:priceInput(`badge${size}_300_499`)},
      {min:500,max:999,price:priceInput(`badge${size}_500_999`)},
    ],qty);
    if(!per)return null;
    total=per*qty;
  }

  if(t==='uvdtf'){
    const meters=Math.max(0,parseFloat(sMeters.value)||0);
    const per=priceInput('uvdtf_per_m');
    const min=priceInput('uvdtf_min');
    if(!per || meters<=0)return null;
    total=Math.max(per*meters,min);
  }

  if(total===null)return null;
  return Math.round(total*(1+(num(sDiscount,0)/100)));
}

function getWideDims(){
  if(wPreset.value==='custom')return {w:num(wWidth,1),h:num(wHeight,1)};
  if(wPreset.value==='A0')return {w:0.841,h:1.189};
  if(wPreset.value==='A1')return {w:0.594,h:0.841};
  if(wPreset.value==='A2')return {w:0.420,h:0.594};
  return {w:1,h:1};
}


function getWideMainByMaterial(mat){
  if(!mat)return '';
  if(mat.startsWith('film_'))return 'film';
  if(mat.startsWith('plastic_'))return 'plastic';
  if(mat.startsWith('plotter_'))return 'plotter';
  if(mat==='latex_backlit')return 'backlit';
  if(mat==='latex_canvas')return 'canvas';
  return '';
}

function syncWideMainButtons(){
  const main=getWideMainByMaterial(wMaterial.value);
  if(wMainButtons){
    [...wMainButtons.querySelectorAll('[data-wmain]')].forEach(btn=>{
      btn.classList.toggle('active',btn.dataset.wmain===main);
    });
  }
}

function syncWideMaterialButtons(){
  const current=wMaterial.value;
  document.querySelectorAll('[data-wmaterial]').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.wmaterial===current);
  });
}

function syncWideToggleButtons(){
  if(wLamBtn){
    wLamBtn.classList.toggle('active',!!(wLam && wLam.checked));
    wLamBtn.disabled=!!(wLam && wLam.disabled);
  }
  if(wCutBtn){
    wCutBtn.classList.toggle('active',!!(wCut && wCut.checked));
    wCutBtn.disabled=!!(wCut && wCut.disabled);
  }
}

function bindWideMaterialButtons(){
  if(wMainButtons){
    wMainButtons.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-wmain]');
      if(!btn)return;
      const map={
        film:'film_gloss',
        plastic:'plastic_3',
        backlit:'latex_backlit',
        canvas:'latex_canvas',
        plotter:'plotter_white_oracal'
      };
      wMaterial.value=map[btn.dataset.wmain]||'';
      updateWideControls();
      syncWideMainButtons();
      syncWideMaterialButtons();
      calc();
    });
  }

  [wFilmButtons,wPlasticButtons,wCutFilmButtons].forEach(container=>{
    if(!container)return;
    container.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-wmaterial]');
      if(!btn)return;
      wMaterial.value=btn.dataset.wmaterial;
      updateWideControls();
      syncWideMainButtons();
      syncWideMaterialButtons();
      calc();
    });
  });

  syncWideMainButtons();
  syncWideMaterialButtons();
}

function updateWideControls(){
  const mat=wMaterial.value||'';
  const main=getWideMainByMaterial(mat);

  if(wFilmGroup)wFilmGroup.classList.toggle('hidden',main!=='film');
  if(wPlasticGroup)wPlasticGroup.classList.toggle('hidden',main!=='plastic');
  if(wPlotterGroup)wPlotterGroup.classList.toggle('hidden',main!=='plotter');
  if(wSizeWrap)wSizeWrap.classList.toggle('hidden',!mat);

  const allowLam=(main==='film' || main==='plastic');
  if(wLam){
    wLam.disabled=!allowLam;
    if(!allowLam)wLam.checked=false;
  }
  if(wCut){
    wCut.disabled=!allowLam;
    if(!allowLam)wCut.checked=false;
  }
  if(wPostWrap)wPostWrap.classList.toggle('hidden',!allowLam);
  if(customSize)customSize.classList.toggle('hidden',!wPreset || wPreset.value!=='custom');

  syncWideMainButtons();
  syncWideToggleButtons();
}

function getWideMaterialRate(){
  switch(wMaterial.value){
    case 'film_gloss': return {rate:num(priceWideFilmGloss,1000), lamAddRate:num(priceWideLamFilm,650)};
    case 'film_clear': return {rate:num(priceWideFilmClear,1000), lamAddRate:num(priceWideLamFilm,650)};
    case 'film_perf': return {rate:num(priceWideFilmPerf,2000), lamAddRate:num(priceWideLamFilm,650)};
    case 'latex_backlit': return {rate:num(priceWideFilmBacklit,2000), lamAddRate:0};
    case 'latex_canvas': return {rate:num(priceWideCanvas,3000), lamAddRate:0};
    case 'plastic_3': {
      const base=num(priceWidePlastic3,3300);
      const withLam=num(priceWidePlastic3Lam,3900);
      return {rate:base, lamAddRate:Math.max(0,withLam-base)};
    }
    case 'plastic_5': {
      const base=num(priceWidePlastic5,4300);
      const withLam=num(priceWidePlastic5Lam,5000);
      return {rate:base, lamAddRate:Math.max(0,withLam-base)};
    }
    case 'plotter_white_china': return {rate:num(priceWidePlotterWhiteChina,1700), lamAddRate:0};
    case 'plotter_white_oracal': return {rate:num(priceWidePlotterWhiteOracal,2000), lamAddRate:0};
    case 'plotter_color_oracal': return {rate:num(priceWidePlotterColorOracal,2000), lamAddRate:0};
    default: return {rate:num(priceWideFilmGloss,1000), lamAddRate:num(priceWideLamFilm,650)};
  }
}

function computeWidePrice(){
  updateWideControls();
  if(!wMaterial.value)return null;
  const dims=getWideDims();
  const area=Math.max(0,dims.w*dims.h);
  const per=Math.max(0,2*(dims.w+dims.h));
  const qty=Math.max(1,parseInt(wQty.value,10)||1);
  const mat=getWideMaterialRate();

  let perItem=area*mat.rate;
  if(wLam && wLam.checked && mat.lamAddRate>0){
    perItem+=area*mat.lamAddRate;
  }
  if(wCut && wCut.checked){
    perItem+=per*num(priceWideCut,30);
  }

  const minPerItem=num(priceWideMinItem,300);
  const total=Math.max(perItem,minPerItem)*qty;
  return Math.round(total*(1+(num(wDiscount,0)/100)));
}


function getWfDims(){
  if(!wfPreset || wfPreset.value==='custom')return {w:num(wfWidth,1),h:num(wfHeight,1)};
  if(wfPreset.value==='A0')return {w:0.841,h:1.189};
  if(wfPreset.value==='A1')return {w:0.594,h:0.841};
  if(wfPreset.value==='A2')return {w:0.420,h:0.594};
  if(wfPreset.value==='A3')return {w:0.297,h:0.420};
  return {w:1,h:1};
}

function getWfMainByType(type){
  if(!type)return '';
  if(type.startsWith('banner_'))return 'banner';
  if(type.startsWith('paper_'))return 'paper';
  return '';
}

function syncWideFmtMainButtons(){
  const main=getWfMainByType(wfType?wfType.value:'');
  if(wfMainButtons){
    [...wfMainButtons.querySelectorAll('[data-wfmain]')].forEach(btn=>{
      btn.classList.toggle('active',btn.dataset.wfmain===main);
    });
  }
}

function syncWideFmtTypeButtons(){
  if(!wfType)return;
  const current=wfType.value;
  document.querySelectorAll('[data-wftype]').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.wftype===current);
  });
}

function bindWideFmtTypeButtons(){
  if(wfMainButtons){
    wfMainButtons.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-wfmain]');
      if(!btn)return;
      wfType.value=(btn.dataset.wfmain==='banner')?'banner_440':'paper_plain';
      updateWideFmtControls();
      syncWideFmtMainButtons();
      syncWideFmtTypeButtons();
      calc();
    });
  }

  if(wfPaperMainButtons){
    wfPaperMainButtons.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-wfpaper]');
      if(!btn)return;
      wfType.value=(btn.dataset.wfpaper==='plain')?'paper_plain':'paper_photo_matte';
      updateWideFmtControls();
      syncWideFmtMainButtons();
      syncWideFmtTypeButtons();
      calc();
    });
  }

  [wfBannerButtons,wfPhotoButtons].forEach(container=>{
    if(!container)return;
    container.addEventListener('click',(e)=>{
      const btn=e.target.closest('[data-wftype]');
      if(!btn)return;
      wfType.value=btn.dataset.wftype;
      updateWideFmtControls();
      syncWideFmtMainButtons();
      syncWideFmtTypeButtons();
      calc();
    });
  });

  syncWideFmtMainButtons();
  syncWideFmtTypeButtons();
}

function syncWideFmtPostButtons(){
  if(wfEyeletsBtn && wfEyeletsEnabled)wfEyeletsBtn.classList.toggle('active',!!wfEyeletsEnabled.checked);
  if(wfWeldBtn && wfWeldLen)wfWeldBtn.classList.toggle('active',!!wfWeldLen.checked);
  if(wfTrimBtn && wfTrimLen)wfTrimBtn.classList.toggle('active',!!wfTrimLen.checked);
  if(wfEyeletsWrap)wfEyeletsWrap.classList.toggle('hidden',!(wfEyeletsEnabled && wfEyeletsEnabled.checked));
  if(wfEyelets)wfEyelets.classList.toggle('hidden',!(wfEyeletsEnabled && wfEyeletsEnabled.checked));
}

function updateWideFmtControls(){
  if(!wfType)return;
  const type=wfType.value||'';
  const main=getWfMainByType(type);
  const isBanner=(main==='banner');
  const isPaper=(main==='paper');
  const isPhoto=(type.startsWith('paper_photo_'));
  const isCustom=(!wfPreset || wfPreset.value==='custom');

  if(wfSizeWrap)wfSizeWrap.classList.toggle('hidden',!main);
  if(wfBannerWrap)wfBannerWrap.classList.toggle('hidden',!isBanner);
  if(wfPaperWrap)wfPaperWrap.classList.toggle('hidden',!isPaper);
  if(wfPhotoButtons)wfPhotoButtons.classList.toggle('hidden',!isPaper || !isPhoto);
  if(wfCustomSize)wfCustomSize.classList.toggle('hidden',!isCustom);
  if(wfPaperFormatWrap)wfPaperFormatWrap.classList.add('hidden');
  if(wfPaperFormatLabel)wfPaperFormatLabel.classList.add('hidden');

  if(wfPreset){
    const a0=[...wfPreset.options].find(o=>o.value==='A0');
    if(a0)a0.disabled=(isPaper && isPhoto);
    if(a0 && a0.disabled && wfPreset.value==='A0')wfPreset.value='A1';
  }

  if(wfQtyLabel){
    if(isBanner)wfQtyLabel.innerText='\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0438\u0437\u0434\u0435\u043b\u0438\u0439';
    else wfQtyLabel.innerText='\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e';
  }

  if(wfPaperMainButtons){
    [...wfPaperMainButtons.querySelectorAll('[data-wfpaper]')].forEach(btn=>{
      const should=(btn.dataset.wfpaper==='photo')?isPhoto:(type==='paper_plain');
      btn.classList.toggle('active',should);
    });
  }

  syncWideFmtMainButtons();
  syncWideFmtPostButtons();
  syncAllChoices();
}

function updateWideFmtDerivedPrices(){
  if(!wfWaterA0Plain12 || !wfWaterA0Plain3p || !wfWaterA1Plain12 || !wfWaterA1Plain3p)return;
  wfWaterA0Plain12.value=String(Math.round(num(wfWaterA1Plain12,200)*2*100)/100);
  wfWaterA0Plain3p.value=String(Math.round(num(wfWaterA1Plain3p,150)*2*100)/100);
  wfWaterA0Plain12.disabled=true;
  wfWaterA0Plain3p.disabled=true;
}

function roundHalfDown(v){
  const n=Number(v);
  if(!Number.isFinite(n))return 0;
  const f=Math.floor(n);
  const frac=n-f;
  if(Math.abs(frac-0.5)<1e-9)return f;
  return Math.round(n);
}

function computeWideFmtPrice(){
  if(!wfType || !wfQty)return null;
  const type=wfType.value||'';
  const qty=Math.max(0,num(wfQty,0));
  if(!type || qty<=0)return null;

  let total=null;

  if(type.startsWith('banner_')){
    const dims=getWfDims();
    const area=Math.max(0,dims.w*dims.h);
    if(area<=0)return null;

    let rate=0;
    if(type==='banner_440')rate=num(wfBanner440,450);
    if(type==='banner_cast')rate=num(wfBannerCast,550);
    if(type==='banner_latex')rate=num(wfBannerLatex,1200);
    if(rate<=0)return null;

    const perimeter=Math.max(0,2*(dims.w+dims.h));
    const eyeletStepCm=Math.max(0,num(wfEyelets,0));
    const hCm=Math.max(0,dims.h*100);
    const wCm=Math.max(0,dims.w*100);
    const eyeletsCount=(wfEyeletsEnabled && wfEyeletsEnabled.checked && eyeletStepCm>0)
      ? Math.max(4,(roundHalfDown(hCm/eyeletStepCm)+roundHalfDown(wCm/eyeletStepCm))*2)
      : 0;
    const addEyelets=eyeletsCount*num(wfPostEyelet,20);
    const addWeld=(wfWeldLen && wfWeldLen.checked)?perimeter*num(wfPostWeld,100):0;
    const addTrim=(wfTrimLen && wfTrimLen.checked)?perimeter*num(wfPostTrim,30):0;

    total=(area*rate+addEyelets+addWeld+addTrim)*qty;
  }

  if(type.startsWith('paper_')){
    const useCustom=(!wfPreset || wfPreset.value==='custom');
    if(useCustom){
      const dims=getWfDims();
      const area=Math.max(0,dims.w*dims.h);
      if(area<=0)return null;
      let rate=num(wfWaterCustomPlainM2,300);
      if(type==='paper_photo_matte' || type==='paper_photo_gloss')rate=num(wfWaterCustomPhotoM2,840);
      if(type==='paper_photo_satin')rate=num(wfWaterCustomSatinM2,1680);
      total=area*rate*qty;
    }else{
      const format=wfPreset.value;
      let per=null;
      if(type==='paper_photo_matte' || type==='paper_photo_gloss' || type==='paper_photo_satin'){
        if(format==='A1')per=num(wfWaterA1Photo12,420);
        if(format==='A2')per=(qty>2?num(wfWaterA2Photo3p,210):num(wfWaterA2Photo12,240));
        if(format==='A3')per=num(wfWaterA3Photo,150);
        if(format==='A0')per=2*num(wfWaterA1Photo12,420);
      }
      if(type==='paper_plain'){
        if(format==='A1')per=(qty>2?num(wfWaterA1Plain3p,150):num(wfWaterA1Plain12,200));
        if(format==='A2')per=(qty>2?num(wfWaterA2Plain3p,75):num(wfWaterA2Plain12,100));
        if(format==='A3')per=(qty>2?num(wfWaterA2Plain3p,75):num(wfWaterA2Plain12,100))/2;
        if(format==='A0')per=2*(qty>2?num(wfWaterA1Plain3p,150):num(wfWaterA1Plain12,200));
      }
      if(!per)return null;
      total=per*qty;
    }
  }

  if(total===null)return null;
  return Math.round(total*(1+(num(wfDiscount,0)/100)));
}

function calc(){
  updateWideFmtDerivedPrices();
  syncVisitButtons();
  syncAllChoices();
  const visitPrice=computeVisitPrice();
  if(visitPrice===null){vPrice.innerText='Цена: -';visitBtn.disabled=true;}else{vPrice.innerText='Цена: '+visitPrice+' ₽';visitBtn.disabled=false;}

  const printPrice=computePrintPrice();
  if(printPrice===null){pPrice.innerText='Цена: -';printBtn.disabled=true;}else{pPrice.innerText='Цена: '+printPrice+' ₽';printBtn.disabled=false;}

  const canvasPrice=computeCanvasPrice();
  if(cPrice && canvasBtn){
    if(canvasPrice===null){cPrice.innerText='\u0426\u0435\u043d\u0430: -';canvasBtn.disabled=true;}else{cPrice.innerText='\u0426\u0435\u043d\u0430: '+canvasPrice+' \u20bd';canvasBtn.disabled=false;}
  }


  const lamPrice=computeLaminationPrice();
  if(lamPrice===null){lPrice.innerText='Цена: -';lamBtn.disabled=true;}else{lPrice.innerText='Цена: '+lamPrice+' ₽';lamBtn.disabled=false;}

  const bfPriceVal=computeBfPrice();
  if(bfPriceVal===null){bfPrice.innerText='Цена: -';bfBtn.disabled=true;}else{bfPrice.innerText='Цена: '+bfPriceVal+' ₽';bfBtn.disabled=false;}

  const sPriceVal=computeSouvenirPrice();
  if(sPriceVal===null){sPrice.innerText='\u0426\u0435\u043d\u0430: -';sBtn.disabled=true;}else{sPrice.innerText='\u0426\u0435\u043d\u0430: '+sPriceVal+' \u20bd';sBtn.disabled=false;}

  const widePriceVal=computeWidePrice();
  if(widePriceVal===null){wPrice.innerText='\u0426\u0435\u043d\u0430: -';wideBtn.disabled=true;}else{wPrice.innerText='\u0426\u0435\u043d\u0430: '+widePriceVal+' \u20bd';wideBtn.disabled=false;}

  const wfPriceVal=computeWideFmtPrice();
  if(wfPriceVal===null){wfPrice.innerText='\u0426\u0435\u043d\u0430: -';wfBtn.disabled=true;}else{wfPrice.innerText='\u0426\u0435\u043d\u0430: '+wfPriceVal+' \u20bd';wfBtn.disabled=false;}
}

function saveVisit(){
  const price=computeVisitPrice();
  if(price===null)return;
  const type=getVisitPriceType();
  const isOffset=(type==='offset');
  const isLam=(type==='digital_mat');
  const qty=vQty.value;
  const sideLabel=(vSide.value==='single'?'4+0':'4+4');
  let title='Визитки';
  if(isOffset)title='Визитки (офсет)';
  if(!isOffset && isLam)title='Визитки (цифровая, мат. ламинация)';
  if(!isOffset && !isLam)title='Визитки (цифровая)';
  const desc=isOffset?`${qty} шт`:`${qty} шт, ${sideLabel}`;
  saveItem({type:'visit',title,desc,price,params:{type,qty,side:vSide.value,lam:isLam,disc:vDiscount.value}});
}

function savePrint(){
  const price=computePrintPrice();
  if(price===null)return;
  const paperLabel=pPaper.options[pPaper.selectedIndex].text;
  const colorLabel=(pColor.value==='bw'?'ч/б':'цветная');
  const cutVal=Math.max(0,num(pCut,0));
  const cutLabel=cutVal>0?`, резка: ${Math.round(cutVal)} ₽`:'';
  const desc=`${paperLabel}, ${pFormat.value}, ${colorLabel}, ${pQty.value} шт${cutLabel}`;
  saveItem({type:'print',title:'Печать',desc,price,params:{paper:pPaper.value,color:pColor.value,format:pFormat.value,qty:pQty.value,side:pSide.value,cut:pCut.value,disc:pDiscount.value}});
}


function saveWide(){
  const price=computeWidePrice();
  if(price===null)return;
  const desc=`${wMaterial.options[wMaterial.selectedIndex].text}, ${wQty.value} \u0448\u0442`;
  saveItem({type:'wide',title:'\u041b\u0430\u0442\u0435\u043a\u0441\u043d\u0430\u044f \u043f\u0435\u0447\u0430\u0442\u044c',desc,price,
    params:{material:wMaterial.value,preset:wPreset.value,w:wWidth.value,h:wHeight.value,qty:wQty.value,disc:wDiscount.value,lam:wLam.checked,cut:wCut.checked}});
}
function saveWideFmt(){
  const price=computeWideFmtPrice();
  if(price===null)return;
  const size=(wfPreset && wfPreset.value==='custom')?`${wfWidth.value}x${wfHeight.value} \u043c`:(wfPreset?wfPreset.value:'A0');
  const desc=`${wfType.options[wfType.selectedIndex].text}, ${size}, ${wfQty.value} \u0448\u0442`;
  saveItem({type:'widefmt',title:'\u0428\u0438\u0440\u043e\u043a\u043e\u0444\u043e\u0440\u043c\u0430\u0442\u043a\u0430',desc,price,params:{
    type:wfType.value,qty:wfQty.value,disc:wfDiscount.value,preset:(wfPreset?wfPreset.value:'custom'),
    w:(wfWidth?wfWidth.value:1),h:(wfHeight?wfHeight.value:1),
    eye:(wfEyelets?wfEyelets.value:0),eyeOn:!!(wfEyeletsEnabled&&wfEyeletsEnabled.checked),
    weld:!!(wfWeldLen&&wfWeldLen.checked),trim:!!(wfTrimLen&&wfTrimLen.checked)
  }});
}
function saveLam(){
  const price=computeLaminationPrice();
  if(price===null)return;
  const qty=lQty.value;
  const sizeLabel=lType.value==='hard_cover'?'':`, ${lSize.options[lSize.selectedIndex].text}`;
  const sheetsLabel=lSheetsWrap.classList.contains('hidden')?'':`, листов: ${lSheets.value}`;
  const title=lType.options[lType.selectedIndex].text;
  const desc=`${qty} шт${sizeLabel}${sheetsLabel}`;
  saveItem({type:'lam',title,desc,price,params:{type:lType.value,qty,size:lSize.value,sheets:lSheets.value,disc:lDiscount.value}});
}

function saveBf(){
  const price=computeBfPrice();
  if(price===null)return;
  const title=bfType.options[bfType.selectedIndex].text;
  const sideLabel=bfSide.value==='single'?'4+0':'4+4';
  const desc=`${bfQty.value} шт${bfSideWrap.classList.contains('hidden')?'':`, ${sideLabel}`}`;
  saveItem({type:'bf',title,desc,price,params:{type:bfType.value,qty:bfQty.value,side:bfSide.value,disc:bfDiscount.value}});
}

function saveSouvenir(){
  const price=computeSouvenirPrice();
  if(price===null)return;
  const title=sType.options[sType.selectedIndex].text;
  let desc='';
  if(sType.value==='mug')desc=`${sMugType.options[sMugType.selectedIndex].text}, ${sQty.value} шт`;
  if(sType.value==='plate')desc=`${sQty.value} шт`;
  if(sType.value==='tshirt')desc=`${sTshirtType.options[sTshirtType.selectedIndex].text}, ${sQty.value} шт`;
  if(sType.value==='magnet_acrylic')desc=`${sMagQty.value} шт`;
  if(sType.value==='magnet_vinyl')desc=`${sMagQty.value} шт`;
  if(sType.value==='badge')desc=`${sBadgeSize.value} мм, ${sQty.value} шт`;
  if(sType.value==='uvdtf')desc=`${sMeters.value} пог.м`;
  saveItem({type:'souvenir',title,desc,price,params:{t:sType.value}});
}

function saveItem(item){
  if(editIndex!==null)orders[editIndex]=item;else orders.push(item);
  render();
  editIndex=null;
  visitBtn.innerText=printBtn.innerText=wideBtn.innerText='Добавить';
  lamBtn.innerText=bfBtn.innerText=sBtn.innerText='Добавить';
  if(designAddBtn)designAddBtn.innerText='\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c';
  if(canvasBtn)canvasBtn.innerText='\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c';
  if(wfBtn)wfBtn.innerText='\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c';
}

function editItem(i){
  const o=orders[i];
  editIndex=i;
  if(o.type==='visit'){
    switchTab('visit');
    vType.value=(o.params.type==='offset'?'offset':'digital');
    vLamCheck.checked=!!o.params.lam;
    populateVisitQty();
    vQty.value=o.params.qty;
    vSide.value=o.params.side;
    syncVisitButtons();
    vDiscount.value=o.params.disc;
    visitBtn.innerText='Изменить';
  }
  if(o.type==='print'){
    switchTab('print');
    pPaper.value=o.params.paper;
    pColor.value=o.params.color;
    updatePrintControls();
updateCanvasControls();
    pFormat.value=o.params.format;
    pQty.value=o.params.qty;
    pSide.value=o.params.side;
    if(pCut)pCut.value=(o.params.cut??0);
    pDiscount.value=o.params.disc;
    printBtn.innerText='Изменить';
  }
  if(o.type==='wide'){
    switchTab('wide');
    const p=o.params;
    wMaterial.value=p.material;
    wPreset.value=p.preset;
    wWidth.value=p.w;
    wHeight.value=p.h;
    wQty.value=p.qty;
    wDiscount.value=p.disc;
    if(wLam)wLam.checked=!!p.lam;
    if(wCut)wCut.checked=!!p.cut;
    toggleCustom();
    updateWideControls();
    wideBtn.innerText='Изменить';
  }
  if(o.type==='widefmt'){
    switchTab('widefmt');
    const p=o.params||{};
    if(wfType)wfType.value=p.type||wfType.value;
    if(wfQty)wfQty.value=p.qty||wfQty.value;
    if(wfDiscount)wfDiscount.value=p.disc||0;
    if(wfPreset)wfPreset.value=p.preset||'custom';
    if(wfWidth)wfWidth.value=p.w||1;
    if(wfHeight)wfHeight.value=p.h||1;
    if(wfEyelets)wfEyelets.value=p.eye||40;
    if(wfEyeletsEnabled)wfEyeletsEnabled.checked=!!p.eyeOn;
    if(wfWeldLen)wfWeldLen.checked=!!p.weld;
    if(wfTrimLen)wfTrimLen.checked=!!p.trim;
    updateWideFmtControls();
    if(wfBtn)wfBtn.innerText='\u0418\u0437\u043c\u0435\u043d\u0438\u0442\u044c';
  }
  if(o.type==='canvas'){
    switchTab('canvas');
    const p=o.params;
    if(cMode)cMode.value=p.mode||'fixed';
    if(cSize)cSize.value=p.size||'30x45';
    if(cTier)cTier.value=p.tier||'retail';
    if(cHeight)cHeight.value=p.h||30;
    if(cWidth)cWidth.value=p.w||40;
    if(cRate)cRate.value=p.rate||2500;
    if(cFrame)cFrame.checked=!!p.frame;
    if(cFramePrice)cFramePrice.value=p.framePrice||500;
    if(cRoundStep)cRoundStep.value=p.roundStep||50;
    if(cApply20)cApply20.checked=!!p.apply20;
    updateCanvasControls();
    if(canvasBtn)canvasBtn.innerText='\u0418\u0437\u043c\u0435\u043d\u0438\u0442\u044c';
  }
  if(o.type==='lam'){
    switchTab('lam');
    const p=o.params||{};
    if(lMode)lMode.value=p.mode||'';
    updateLaminationControls();
    lType.value=p.type;
    updateLaminationControls();
    lQty.value=p.qty;
    lSize.value=p.size;
    lSheets.value=p.sheets;
    lDiscount.value=p.disc;
    lamBtn.innerText='\u0418\u0437\u043c\u0435\u043d\u0438\u0442\u044c';
  }
  if(o.type==='design'){
    switchTab('design');
    if(designPrice)designPrice.value=o.params.price;
    if(designAddBtn)designAddBtn.innerText='Изменить';
  }
  calc();
}
function delItem(i){
  orders.splice(i,1);
  render();
}


function setupNumericKeypad(){
  if(!numPad)return;
  const dragHandle=document.getElementById('numPadDrag');
  let activeInput=null;
  let dragging=false;
  let dragOffsetX=0;
  let dragOffsetY=0;
  let movedManually=false;

  const clamp=(value,min,max)=>Math.min(max,Math.max(min,value));

  const placeNearInput=(input)=>{
    if(!input)return;
    const rect=input.getBoundingClientRect();
    const width=numPad.offsetWidth||260;
    const height=numPad.offsetHeight||240;
    let left=rect.left;
    let top=rect.bottom+8;

    if(left+width>window.innerWidth-8)left=window.innerWidth-width-8;
    if(top+height>window.innerHeight-8)top=rect.top-height-8;

    left=clamp(left,8,Math.max(8,window.innerWidth-width-8));
    top=clamp(top,8,Math.max(8,window.innerHeight-height-8));

    numPad.style.left=`${left}px`;
    numPad.style.top=`${top}px`;
    numPad.style.right='auto';
    numPad.style.bottom='auto';
  };

  const show=(input)=>{
    if(!input || input.disabled || input.readOnly)return;
    const changedInput=activeInput!==input;
    activeInput=input;
    if(changedInput)movedManually=false;
    numPad.classList.remove('hidden');
    numPad.setAttribute('aria-hidden','false');
    if(!movedManually){
      requestAnimationFrame(()=>placeNearInput(input));
    }
  };

  const hide=()=>{
    activeInput=null;
    dragging=false;
    numPad.classList.add('hidden');
    numPad.setAttribute('aria-hidden','true');
  };

  const applyValue=(next)=>{
    if(!activeInput)return;
    activeInput.value=next;
    activeInput.dispatchEvent(new Event('input',{bubbles:true}));
    activeInput.dispatchEvent(new Event('change',{bubbles:true}));
  };

  const insert=(chunk)=>{
    if(!activeInput)return;
    const cur=String(activeInput.value||'');
    if(chunk==='-'){
      applyValue(cur.startsWith('-')?cur.slice(1):('-'+cur));
      return;
    }

    if(chunk===',' || chunk==='.'){
      if(cur.includes('.'))return;
      if(cur==='' || cur==='-'){
        applyValue(`${cur}0.`);
      }else{
        applyValue(cur+'.');
      }
      return;
    }

    applyValue(cur+chunk);
  };

  document.addEventListener('focusin',(e)=>{
    const input=e.target.closest('input[type="number"]');
    if(input)show(input);
  });

  document.addEventListener('keydown',(e)=>{
    if(!activeInput)return;
    if(e.target===activeInput)hide();
  });

  document.addEventListener('mousedown',(e)=>{
    if(!numPad.contains(e.target) && !e.target.closest('input[type="number"]'))hide();
  });

  if(dragHandle){
    dragHandle.addEventListener('mousedown',(e)=>{
      if(numPad.classList.contains('hidden'))return;
      const rect=numPad.getBoundingClientRect();
      dragging=true;
      movedManually=true;
      dragOffsetX=e.clientX-rect.left;
      dragOffsetY=e.clientY-rect.top;
      e.preventDefault();
    });

    document.addEventListener('mousemove',(e)=>{
      if(!dragging)return;
      const width=numPad.offsetWidth||260;
      const height=numPad.offsetHeight||240;
      const left=clamp(e.clientX-dragOffsetX,8,Math.max(8,window.innerWidth-width-8));
      const top=clamp(e.clientY-dragOffsetY,8,Math.max(8,window.innerHeight-height-8));
      numPad.style.left=`${left}px`;
      numPad.style.top=`${top}px`;
      numPad.style.right='auto';
      numPad.style.bottom='auto';
    });

    document.addEventListener('mouseup',()=>{dragging=false;});
  }

  window.addEventListener('resize',()=>{
    if(activeInput && !numPad.classList.contains('hidden') && !movedManually){
      placeNearInput(activeInput);
    }
  });

  numPad.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-numkey]');
    if(!btn || !activeInput)return;
    const key=btn.dataset.numkey;
    if(key==='back'){
      applyValue(String(activeInput.value||'').slice(0,-1));
      return;
    }
    if(key==='clear'){
      applyValue('');
      return;
    }
    if(key==='close' || key==='enter'){
      hide();
      return;
    }
    insert(key);
  });
}

function buildOrderCopyText(){
  let date=new Date().toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
  date=date.replace(/\s*\u0433\.?$/i,'');
  const lines=[`**\uD83D\uDCC4 \u0412\u0430\u0448 \u0437\u0430\u043A\u0430\u0437**`,`__\uD83D\uDCC5 ${date} \u0433.__`,''];

  orders.forEach((o)=>{
    lines.push(`\u25B8 **${o.title}**`);
    lines.push(`    ${o.desc}`);
    lines.push(`    \u0421\u0442\u043E\u0438\u043C\u043E\u0441\u0442\u044C: **${o.price} \u20BD**`);
    lines.push('');
  });

  lines.push('\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500');
  lines.push(`**\u0418\u0422\u041E\u0413\u041E: ${total.innerText}**`);
  return lines.join('\n');
}

function buildOrderCopyMailHtml(){
  let date=new Date().toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
  date=date.replace(/\s*\u0433\.?$/i,'');
  const rows=['<div><b>\uD83D\uDCC4 \u0412\u0430\u0448 \u0437\u0430\u043A\u0430\u0437</b></div>',`<div><i>\uD83D\uDCC5 ${date} \u0433.</i></div>`,'<div>&nbsp;</div>'];

  orders.forEach((o)=>{
    rows.push(`<div>\u25B8 <b>${o.title}</b></div>`);
    rows.push(`<div>&nbsp;&nbsp;&nbsp;&nbsp;${o.desc}</div>`);
    rows.push(`<div>&nbsp;&nbsp;&nbsp;&nbsp;\u0421\u0442\u043E\u0438\u043C\u043E\u0441\u0442\u044C: <b>${o.price} \u20BD</b></div>`);
    rows.push('<div>&nbsp;</div>');
  });

  rows.push('<div>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500</div>');
  rows.push(`<div><b>\u0418\u0422\u041E\u0413\u041E: ${total.innerText}</b></div>`);
  return rows.join('');
}

function setCopyBtnState(btn, ok){
  if(!btn)return;
  const prev=btn.innerText;
  btn.innerText=ok?'\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e':'\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c';
  setTimeout(()=>{btn.innerText=prev;},1200);
}

async function copyOrderText(){
  if(!orders.length)return;
  const text=buildOrderCopyText();
  let ok=false;

  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      ok=true;
    }
  }catch(_e){}

  if(!ok){
    const ta=document.createElement('textarea');
    ta.value=text;
    ta.style.position='fixed';
    ta.style.opacity='0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{ok=document.execCommand('copy');}catch(_e){ok=false;}
    document.body.removeChild(ta);
  }

  setCopyBtnState(copyOrderBtn, ok);
}

async function copyOrderMail(){

  if(!orders.length)return;
  const html=buildOrderCopyMailHtml();
  const text=html.replace(/<[^>]*>/g,'');
  let ok=false;

  try{
    if(navigator.clipboard && window.isSecureContext && window.ClipboardItem){
      const item=new ClipboardItem({
        'text/html': new Blob([html],{type:'text/html'}),
        'text/plain': new Blob([text],{type:'text/plain'})
      });
      await navigator.clipboard.write([item]);
      ok=true;
    }
  }catch(_e){}

  if(!ok){
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        ok=true;
      }
    }catch(_e){}
  }

  if(!ok){
    const ta=document.createElement('textarea');
    ta.value=text;
    ta.style.position='fixed';
    ta.style.opacity='0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{ok=document.execCommand('copy');}catch(_e){ok=false;}
    document.body.removeChild(ta);
  }

  setCopyBtnState(copyOrderMailBtn, ok);
}

function updateOrderToggle(){
  if(!orderToggle || !orderPanel)return;
  const isCollapsed=orderPanel.classList.contains('collapsed');
  orderToggle.innerText=`${isCollapsed?'Показать':'Скрыть'} позиции (${orders.length})`;
}

function bindOrderToggle(){
  if(!orderToggle || !orderPanel || !orderDetails)return;
  orderToggle.addEventListener('click',()=>{
    orderPanel.classList.toggle('collapsed');
    updateOrderToggle();
  });
  updateOrderToggle();
}
function render(){
  order.innerHTML='';
  let sum=0;
  orders.forEach((o,i)=>{
    sum+=o.price;
    order.innerHTML+=`<div class="order-row"><div>${o.title}<br><small>${o.desc}</small></div><div>${o.price} ₽</div><div><span class=edit onclick=editItem(${i})>✎</span><span class=del onclick=delItem(${i})>✖</span></div></div>`;
  });
  total.innerText=sum+' ₽';
  if(copyOrderBtn)copyOrderBtn.disabled=orders.length===0;
  if(copyOrderMailBtn)copyOrderMailBtn.disabled=orders.length===0;
  updateOrderToggle();
}

function bindCalc(){
  const inputs=[vType,vQty,vSide,vLamCheck,vDiscount,pPaper,pColor,pFormat,pQty,pSide,pCut,pDiscount,cMode,cSize,cTier,cHeight,cWidth,cRate,cFrame,cFramePrice,cRoundStep,cApply20,cFormulaRate,cFormulaFrame,cFormulaRound,wMaterial,wLam,wCut,wPreset,wWidth,wHeight,wQty,wDiscount,
    lMode,lType,lSize,lQty,lSheets,lDiscount,bfType,bfQty,bfSide,bfDiscount,sType,sMugType,sTshirtType,sBadgeSize,sMagQty,sQty,sMeters,sDiscount,
    wfType,wfQty,wfDiscount,wfPreset,wfWidth,wfHeight,wfEyelets,wfEyeletsEnabled,wfWeldLen,wfTrimLen,wfPaperFormat,
    priceWideFilmGloss,priceWideFilmClear,priceWideFilmPerf,priceWideFilmBacklit,priceWideLamFilm,priceWidePlastic3,priceWidePlastic3Lam,priceWidePlastic5,priceWidePlastic5Lam,priceWidePlotterWhiteChina,priceWidePlotterWhiteOracal,priceWidePlotterColorOracal,priceWideCut,priceWideMinItem,
    wfBanner440,wfBannerCast,wfBannerLatex,wfPostEyelet,wfPostWeld,wfPostTrim,wfWaterA1Photo12,wfWaterA2Photo12,wfWaterA2Photo3p,wfWaterA3Photo,wfWaterA1Plain12,wfWaterA1Plain3p,wfWaterA2Plain12,wfWaterA2Plain3p,wfWaterA0Plain12,wfWaterA0Plain3p,wfWaterCustomPlainM2,wfWaterCustomPhotoM2,wfWaterCustomSatinM2];
  inputs.forEach(el=>{if(!el)return;el.addEventListener('input',calc);el.addEventListener('change',calc);});

  vType.addEventListener('change',()=>{populateVisitQty();calc();});
  vLamCheck.addEventListener('change',()=>{populateVisitQty();calc();});
  if(vLamBtn){
    vLamBtn.addEventListener('click',()=>{
      if(vLamBtn.disabled)return;
      vLamCheck.checked=!vLamCheck.checked;
      populateVisitQty();
      calc();
    });
  }
  vTypeButtons.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-vtype]');
    if(!btn)return;
    vType.value=btn.dataset.vtype;
    populateVisitQty();
    calc();
  });
  vSideButtons.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-vside]');
    if(!btn || btn.disabled)return;
    vSide.value=btn.dataset.vside;
    syncVisitButtons();
    calc();
  });
  vQtyButtons.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-vqty]');
    if(!btn)return;
    vQty.value=btn.dataset.vqty;
    syncVisitButtons();
    calc();
  });
  pPaper.addEventListener('change',()=>{updatePrintControls();calc();});
  if(cMode)cMode.addEventListener('change',()=>{updateCanvasControls();calc();});
  if(cFrameButtons){cFrameButtons.addEventListener('click',(e)=>{const btn=e.target.closest('[data-cframe]');if(!btn||!cFrame)return;cFrame.checked=!cFrame.checked;syncCanvasToggleButtons();calc();});}
  if(cApply20Buttons){cApply20Buttons.addEventListener('click',(e)=>{const btn=e.target.closest('[data-cdisc20]');if(!btn||!cApply20)return;cApply20.checked=!cApply20.checked;syncCanvasToggleButtons();calc();});}
  if(wLamBtn){wLamBtn.addEventListener('click',()=>{if(!wLamBtn.disabled && wLam){wLam.checked=!wLam.checked;updateWideControls();calc();}});}
  if(wCutBtn){wCutBtn.addEventListener('click',()=>{if(!wCutBtn.disabled && wCut){wCut.checked=!wCut.checked;updateWideControls();calc();}});}
  wMaterial.addEventListener('change',()=>{updateWideControls();syncWideMaterialButtons();calc();});
  if(lMode)lMode.addEventListener('change',()=>{updateLaminationControls();calc();});
  lType.addEventListener('change',()=>{updateLaminationControls();calc();});
  if(wfType)wfType.addEventListener('change',()=>{updateWideFmtControls();syncWideFmtTypeButtons();syncWideFmtMainButtons();calc();});
  if(wfPreset)wfPreset.addEventListener('change',()=>{updateWideFmtControls();calc();});
  bfType.addEventListener('change',()=>{populateBfQty();calc();});
  sType.addEventListener('change',()=>{updateSouvenirControls();calc();});

  const priceInputs=[...settingsModal.querySelectorAll('input')];
  priceInputs.forEach(el=>el.addEventListener('input',calc));
  const formulaInputs=[cFormulaRate,cFormulaFrame,cFormulaRound];
  formulaInputs.forEach(el=>{
    if(!el)return;
    el.addEventListener('input',()=>{if(cMode && cMode.value==='custom'){updateCanvasControls();calc();}});
  });
}
setupChoice(pPaper,pPaperButtons,'ppaper');
setupChoice(pColor,pColorButtons,'pcolor');
setupChoice(pFormat,pFormatButtons,'pformat');
setupChoice(pSide,pSideButtons,'pside');
setupChoice(cMode,cModeButtons,'cmode');
setupChoice(cSize,cSizeButtons,'csize');
setupChoice(cTier,cTierButtons,'ctier');
setupChoice(wPreset,wPresetButtons,'wpreset');
setupChoice(lMode,lModeButtons,'lmode');
setupChoice(lType,lTypeButtons,'ltype');
setupChoice(lSize,lSizeButtons,'lsize');
setupChoice(bfType,bfTypeButtons,'bftype');
setupChoice(bfQty,bfQtyButtons,'bfqty');
setupChoice(bfSide,bfSideButtons,'bfside');
setupChoice(sType,sTypeButtons,'stype');
setupChoice(sMugType,sMugTypeButtons,'smug');
setupChoice(sTshirtType,sTshirtTypeButtons,'stshirt');
setupChoice(sBadgeSize,sBadgeSizeButtons,'sbadge');
setupChoice(sMagQty,sMagQtyButtons,'smagqty');
setupChoice(wfPreset,wfPresetButtons,'wfpreset');
setupChoice(wfPaperFormat,wfPaperFormatButtons,'wfpformat');

populateVisitQty();
updatePrintControls();
updateCanvasControls();
updateLaminationControls();
populateBfQty();
updateSouvenirControls();
updateWideFmtControls();

tabButtons.forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
if(priceBtn)priceBtn.addEventListener('click',openSettings);
if(settingsModal){
  settingsModal.addEventListener('click',(e)=>{if(e.target===settingsModal)closeSettings();});
}

setupThemeToggle();
switchTab('visit');
bindCalc();
bindDiscountQuick();
bindPrintCutQuick();
bindWideMaterialButtons();
bindWideFmtTypeButtons();
bindDesignService();
bindOrderToggle();
setupNumericKeypad();
if(copyOrderBtn)copyOrderBtn.addEventListener('click',copyOrderText);
if(copyOrderMailBtn)copyOrderMailBtn.addEventListener('click',copyOrderMail);
calc();

window.switchTab=switchTab;
window.openSettings=openSettings;
window.closeSettings=closeSettings;
























